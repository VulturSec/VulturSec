<!DOCTYPE html>
<html lang="en-us"><head>


  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>Behind the Cheat - Angry Birds Classics</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description"
    content="Understanding cheats in mobile games">

    
    <link rel="icon" href="https://vultursec.com/images/favicon.ico" type="image/gif" sizes="16x16">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="Description" content="Enter your description here">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" as="style" onload="this.onload=null;this.rel=&#39;stylesheet&#39;"/>

    
    <link rel="stylesheet" href="https://vultursec.com/css/style.css">

    
    <script src="https://vultursec.com/js/lazysizes.min.js"></script>

    
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <link href="https://vultursec.com/css/css2" rel="stylesheet">


  <!--Favicon-->
  <link rel="shortcut icon" href="https://vultursec.com/images/favicon.ico" type="image/x-icon">
  <link rel="icon" href="https://vultursec.com/images/favicon.ico" type="image/x-icon">


</head>
<body class="white-page">


    <header class="fixed">
      <div class="container">
        <nav class="navbar navbar-light">
          

          <a class="navbar-brand aos-init aos-animate" href="https://vultursec.com/index.html" data-aos="fade-down" data-aos-delay="300"><img src="https://vultursec.com/images/logo.png" alt="Logo" class="img-responsive"></a>
          <div class="right-container">
            <ul class="social-links">
              <li>
                <a href="https://twitter.com/vultursec" target="_blank"><i class="fab fa-twitter"></i></a>
              </li>
              <li>
                <a href="https://linkedin.com/company/vultursec" target="_blank"><i class="fab fa-linkedin-in"></i></a>
              </li> 
              <li>
                <a href="https://github.com/vultursec" target="_blank"><i class="fab fa-github"></i></a>
              </li>
            </ul>
            <button class="navbar-toggler collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
              
              <img src="https://vultursec.com/images/menu-open.png" alt="Menu" class="img-responsive">
            </button>
          </div>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <button class="navbar-toggler collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
              <img src="https://vultursec.com/images/image-close.png" alt="Menu" class="img-responsive">
            </button>
            <div class="navbar-wrapper">
              <a class="navbar-brand visible-mobile aos-init aos-animate" href="https://vultursec.com/index.html" data-aos="fade-down" data-aos-delay="300"><img src="https://vultursec.com/images/logo.png" alt="Logo" class="img-responsive"></a>
              <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                  <a href="https://vultursec.com/index.html#home">Home</a>
                </li>
                <li class="nav-item">
                  <a href="https://vultursec.com/index.html#about">About</a>
                </li>
                <li class="nav-item">
                  <a href="https://vultursec.com/index.html#services">Services</a>
                </li>
                <li class="nav-item">
                  <a href="https://vultursec.com/index.html#how-we-work">How we work</a>
                </li>
                <li class="nav-item">
                  <a href="https://vultursec.com/index.html#contact">Contact us</a>
                </li>
                <li class="nav-item">
                  <a href="https://vultursec.com/blog/">Blog</a>
                </li>
              </ul>
            </div>
          </div>
        </nav>
      </div>
    </header>




	


<section class="single-post-banner">
  <div class="container">
    <div class="row">
      <div class="col-md-4 col-sm-6 col-12">
        <div class="content">
          <div
            class="section-heading big"
            data-aos="fade-down"
            data-aos-delay="100"
          >
            <h1>Behind the Cheat - Angry Birds Classics</h1>
          </div>
          <div class="author-meta-details">
            Posted by VulturSec Team, on 14 Feb, 2024 
          </div>
          <div class="section-text" data-aos="fade-in" data-aos-delay="300">
            <p>
              Hello everyone! I wanted to analyze some cheats on mobile videogames to understand the techniques used in this field.
            </p>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-sm-6 col-12">
        <div class="image" data-aos="fade-left" data-aos-delay="500">
          <img
            src="/images/blog/behind-the-cheat-1/angry-birds-image.jpeg"
            alt="Blog Image"
            class="img-responsive"
          />
        </div>
      </div>
    </div>
  </div>
</section>

	



<section class="single-post-section">
  <div class="container">
    
    <div class="row">
      
      <div class="section-heading">
        <h3>Behind the Cheat - Angry Birds Classics</h3>
      </div>
      <div class="col-lg-9 order-1 order-lg-1">
        
        <div class="row">
        <div class="col-12 my-4">
          <div class="border-bottom"></div>
        </div>
        
        <div class="col-12 mb-5 text">
          <p>Hello everyone! I wanted to analyze some cheats on mobile videogames to understand the techniques used in this field. So here it is a series that will go deep on the techniques used on different mods and cheats.</p>
<p>The first game I chose was <em>Angry Birds</em>, as it was a game I liked a lot when it was a boom some years ago. I won´t deliver the exact version of the modded application because I do not want to distribute malicious or adultered content, even if it is something educational, so you´ll need to find it by yourselves.</p>
<p>The application downloaded claimed that it had a cheat related to unlimited money. This type of mods generally changes the way money is subtracted when something is bought. In this case the cool thing of the hack is that you could patch the assembler instruction used to add instead, so it is virtually unlimited money. The second way I saw this is not really unlimited but a change on the save files in order to change the amount of coins to a high number.</p>
<p>As Angry Birds Classics is not available anymore we won&rsquo;t have the possibility to run it and understand dinamically how the game works and if the claimed hack works efectivelly. We will go through the modding techniques and I&rsquo;ll explain the process followed in order to understand how the mod was supposed to work.</p>
<p><strong>1. Get the original version</strong></p>
<p>The first thing I like to do to check where is the hack is to compare the modded version vs the original one, so you´ll need to know which is the original version modded. That is generally easy because the mods try to change specific features on a game and not to hide the version of the original game. In some AAA games that is even an added value because it is a way to know that the hack will work on the latest available version. In fact, in some games (given the importance the company adds to mods and cheats), only the last version of the game will let you play online.</p>
<p>In order to check the version of the modded application you can open the game with Jadx, and check the content of the <em>AndroidManifest</em> and view the <em>android:versionName</em> attribute on the first tag &ldquo;&lt;manifest&gt;&rdquo;:</p>
<p><img src="/images/blog/behind-the-cheat-1/image1.png" alt="Mobile Game Hacking: Angry Birds 1"></p>
<p>With the version I download the correct version from <em>Apkpure</em> or other store. You could also try to download it from google play directly, but as I start with a static analysis I prefer to download it in my PC and then install it later in the emulator or the device.</p>
<p><strong>2. Compare the versions</strong></p>
<p>In order to make a comparison I start with the decoded original and modded version with the <em>Apktool</em> tool. Doing this will give us an idea of where the changes are, as the tool unzips the apks (which can help us to compare assets and native libs), it will generate the <em>Smali</em> of the <em>Dex</em> files (which can help us to compare <em>Java</em> files between the versions), and it will generate the Android Manifest and other xml files (which will help to see if there is any changes in parameters or in the manifest itself).</p>
<p>The objective of this step is to understand where is the change, but not what is the change. It will guide us in further investigations. As an example if the changes detected are in the native libraries, we will need to execute a binary diff. If the changes are in the <em>.smali</em> files we will need to check the <em>Jadx</em> output in order to understand what the change is.</p>
<p>In my case I used <em>WinMerge</em> (as at the time of writing I&rsquo;m using a Windows OS), but you can use any tool to achieve the same goal. Luckily there were a really small amount of changes, as it can be seen in the following image, where the left side shows the files of the modded app and the right the ones from the original app:</p>
<p><img src="/images/blog/behind-the-cheat-1/image2.png" alt="Mobile Game Hacking: Angry Birds 2"></p>
<p>As it can be seen the changes are mainly in the <em>Java</em> layer. We can see a new file called <em>data.save</em> in the assets, then changes in the <em>META-INF</em> folder which is expected as the application is signed again by the modder, so the <em>CERT.</em>* files correspond to the new signing certificate and the <em>MANIFEST.MF</em> to the new signatures of the files given the new certificates. We can ignore these changes.</p>
<p>Then we have three new classes, and the change of the <em>App</em> class. The new classes will be reviewed in JADX in order to avoid reading <em>smali</em> files, but the <em>App</em> class will be seen in this diff tool as it will be easier to understand where are the changes.</p>
<p><strong>3. Understanding the mod</strong></p>
<p>The first thing I reviewed was the <em>App.smali</em> file, which adds the following instructions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>.<span style="color:#a6e22e">method</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">onCreate</span>(<span style="color:#a6e22e">Landroid</span><span style="color:#f92672">/</span><span style="color:#a6e22e">os</span><span style="color:#f92672">/</span><span style="color:#a6e22e">Bundle</span>;)<span style="color:#a6e22e">V</span>
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">locals</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">prologue</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">invoke</span><span style="color:#f92672">-</span><span style="color:#66d9ef">static</span><span style="color:#f92672">/</span><span style="color:#a6e22e">range</span> {<span style="color:#a6e22e">p0</span> .. <span style="color:#a6e22e">p0</span>}, <span style="color:#a6e22e">Lcom</span><span style="color:#f92672">/</span><span style="color:#a6e22e">savegame</span><span style="color:#f92672">/</span><span style="color:#a6e22e">SavesRestoring</span>;<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">DoSmth</span>(<span style="color:#a6e22e">Landroid</span><span style="color:#f92672">/</span><span style="color:#a6e22e">content</span><span style="color:#f92672">/</span><span style="color:#a6e22e">Context</span>;)<span style="color:#a6e22e">V</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">move</span><span style="color:#f92672">-</span><span style="color:#a6e22e">object</span><span style="color:#f92672">/</span><span style="color:#a6e22e">from16</span> <span style="color:#a6e22e">v0</span>, <span style="color:#a6e22e">p0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">invoke</span><span style="color:#f92672">-</span><span style="color:#66d9ef">static</span> {<span style="color:#a6e22e">v0</span>}, <span style="color:#a6e22e">Lcom</span><span style="color:#f92672">/</span><span style="color:#a6e22e">android</span><span style="color:#f92672">/</span><span style="color:#a6e22e">unityengine</span><span style="color:#f92672">/</span><span style="color:#a6e22e">UnityPIayerNativeActivity</span>;<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">Init</span>(<span style="color:#a6e22e">Landroid</span><span style="color:#f92672">/</span><span style="color:#a6e22e">content</span><span style="color:#f92672">/</span><span style="color:#a6e22e">Context</span>;)<span style="color:#a6e22e">V</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span><span style="color:#f92672">-</span><span style="color:#a6e22e">string</span> <span style="color:#a6e22e">v0</span>, <span style="color:#e6db74">&#34;GREOzg7MjsgICBBTkRST0lELTEuQ09NICA7&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">invoke</span><span style="color:#f92672">-</span><span style="color:#66d9ef">static</span> {<span style="color:#a6e22e">p0</span>, <span style="color:#a6e22e">v0</span>}, <span style="color:#a6e22e">Lcom</span><span style="color:#f92672">/</span><span style="color:#a6e22e">rovio</span><span style="color:#f92672">/</span><span style="color:#a6e22e">fusion</span><span style="color:#f92672">/</span><span style="color:#a6e22e">Application</span>;<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">finish</span>(<span style="color:#a6e22e">Landroid</span><span style="color:#f92672">/</span><span style="color:#a6e22e">content</span><span style="color:#f92672">/</span><span style="color:#a6e22e">Context</span>;<span style="color:#a6e22e">Ljava</span><span style="color:#f92672">/</span><span style="color:#a6e22e">lang</span><span style="color:#f92672">/</span>String;)<span style="color:#a6e22e">V</span>
</span></span></code></pre></div><p>This will add the following code to the <em>onCreate</em> method in the <em>App.java</em> class:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onCreate</span><span style="color:#f92672">(</span>Bundle bundle<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    SavesRestoring<span style="color:#f92672">.</span><span style="color:#a6e22e">DoSmth</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    UnityPIayerNativeActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">Init</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    Application<span style="color:#f92672">.</span><span style="color:#a6e22e">finish</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;GREOzg7MjsgICBBTkRST0lELTEuQ09NICA7&#34;</span><span style="color:#f92672">);</span>
</span></span></code></pre></div><p>The <em>App</em> class is not any class. It is the <em>MainActivity</em>, which is the activity that is initially launched when the application is started, and the first method to execute in this application is the <em>onCreate</em> one. So the added code will probably always run unless the application is started through any other class. But as the way an end user starts an application is through the main Activity, it will effectively run.</p>
<p>&ldquo;SaveRestoring&rdquo; and the &ldquo;UnityPIayerNativeActivity&rdquo; are classes added in the mod. Let&rsquo;s see what each one of those do:</p>
<p><em>SaveRestoring.DOSmth</em></p>
<p>Call <em>SmartDataRestoreForYou</em>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">DoSmth</span><span style="color:#f92672">(</span>Context context<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        SmartDataRestoreForYou<span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getAssets</span><span style="color:#f92672">(),</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getPackageName</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Log<span style="color:#f92672">.</span><span style="color:#a6e22e">e</span><span style="color:#f92672">(</span>context<span style="color:#f92672">.</span><span style="color:#a6e22e">getPackageName</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;:savemessages&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Message: &#34;</span> <span style="color:#f92672">+</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessage</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>In the following method I removed unimportant things and added comments related to what some lines do in order to make it easier to understand:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">SmartDataRestoreForYou</span><span style="color:#f92672">(</span>Context context<span style="color:#f92672">,</span> AssetManager assetManager<span style="color:#f92672">,</span> String str<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//this is a flag that assures that if this method was already run, does not run a new one by setting a flag in a sharedprefs called savegame:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>context<span style="color:#f92672">.</span><span style="color:#a6e22e">getSharedPreferences</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;savegame&#34;</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">).</span><span style="color:#a6e22e">getBoolean</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;notfirst&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//if it is the first time, the first thing to do is set savegame
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    context<span style="color:#f92672">.</span><span style="color:#a6e22e">getSharedPreferences</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;savegame&#34;</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">).</span><span style="color:#a6e22e">edit</span><span style="color:#f92672">().</span><span style="color:#a6e22e">putBoolean</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;notfirst&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">).</span><span style="color:#a6e22e">commit</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//AssetManager lists all the files in the /assets folder
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    String<span style="color:#f92672">[]</span> list <span style="color:#f92672">=</span> assetManager<span style="color:#f92672">.</span><span style="color:#a6e22e">list</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> list<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Log<span style="color:#f92672">.</span><span style="color:#a6e22e">i</span><span style="color:#f92672">(</span>str2<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;ListFiles[&#34;</span> <span style="color:#f92672">+</span> i <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;] = &#34;</span> <span style="color:#f92672">+</span> list<span style="color:#f92672">[</span>i<span style="color:#f92672">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//search for the data.save file (which is in out assets folder)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ExistsInArray<span style="color:#f92672">(</span>list<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;data.save&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Toast<span style="color:#f92672">.</span><span style="color:#a6e22e">makeText</span><span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Restoring save...&#34;</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//unzips the file data.save to the root folder of the application (/data/data/pacakge_id)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            Log<span style="color:#f92672">.</span><span style="color:#a6e22e">i</span><span style="color:#f92672">(</span>str2<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;data.save : Restoring...&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            unZipIt<span style="color:#f92672">(</span>assetManager<span style="color:#f92672">.</span><span style="color:#a6e22e">open</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;data.save&#34;</span><span style="color:#f92672">),</span> <span style="color:#e6db74">&#34;/data/data/&#34;</span> <span style="color:#f92672">+</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getPackageName</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>            Log<span style="color:#f92672">.</span><span style="color:#a6e22e">i</span><span style="color:#f92672">(</span>str2<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;data.save: Successfully restored&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            Log<span style="color:#f92672">.</span><span style="color:#a6e22e">e</span><span style="color:#f92672">(</span>str2<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;data.save: Message: &#34;</span> <span style="color:#f92672">+</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessage</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>            Toast<span style="color:#f92672">.</span><span style="color:#a6e22e">makeText</span><span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Can&#39;t restore save&#34;</span><span style="color:#f92672">,</span> 1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//do the same as data.save but with a file in the obb folder
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ExistsInArray<span style="color:#f92672">(</span>list<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;extobb.save&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//do the same as data.save but with a file in the external storage folder
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ExistsInArray<span style="color:#f92672">(</span>list<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;extdata.save&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><em>UnityPIayerNativeActivity.Init</em></p>
<p>This file has a curious name, as it is like the <em>UnityPlayerNativeActivity</em> activity which is a common classes in Unity games. I assume that this is to hide the behavior from someone who wants to understand how the library works.</p>
<p>The method executes the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Init</span><span style="color:#f92672">(</span>Context context<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* The first time the application is launched the sharedprefs InUnityEngine.xml does not exists, so the getBoolean from that unexistent file will return the default value (which is the second parameter of getBoolean). As it is true, it will get in the if content. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>context<span style="color:#f92672">.</span><span style="color:#a6e22e">getSharedPreferences</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;IsUnityEngine&#34;</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">).</span><span style="color:#a6e22e">getBoolean</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Create&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* Sets the flag Create as false, so the second time the application is started the value Create will return false and will not get in the if statement */</span>   
</span></span><span style="display:flex;"><span>        context<span style="color:#f92672">.</span><span style="color:#a6e22e">getSharedPreferences</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;IsUnityEngine&#34;</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">).</span><span style="color:#a6e22e">edit</span><span style="color:#f92672">().</span><span style="color:#a6e22e">putBoolean</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Create&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">).</span><span style="color:#a6e22e">commit</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//shows the message &#39;Android-1.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        Toast<span style="color:#f92672">.</span><span style="color:#a6e22e">makeText</span><span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> String<span style="color:#f92672">(</span>Base64<span style="color:#f92672">.</span><span style="color:#a6e22e">decode</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ICAgQW5kcm9pZC0xLmNvbSAg&#34;</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">)),</span> 1<span style="color:#f92672">).</span><span style="color:#a6e22e">show</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><em>Application.finish</em></p>
<p>The method is the following one, and I will print the content as debugging in order to make it easier to understand:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">//receives &#39;GREOzg7MjsgICBBTkRST0lELTEuQ09NICA7&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">finish</span><span style="color:#f92672">(</span>Context context<span style="color:#f92672">,</span> String str<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    SharedPreferences sharedPreferences <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getSharedPreferences</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;isAdsReadyForReward&#34;</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    SharedPreferences<span style="color:#f92672">.</span><span style="color:#a6e22e">Editor</span> edit <span style="color:#f92672">=</span> sharedPreferences<span style="color:#f92672">.</span><span style="color:#a6e22e">edit</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//deletes the first three chars from the string and decodes it: ;8;2;   ANDROID-1.COM  ;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//then splits it by ;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    String<span style="color:#f92672">[]</span> split <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> String<span style="color:#f92672">(</span>Base64<span style="color:#f92672">.</span><span style="color:#a6e22e">decode</span><span style="color:#f92672">(</span>str<span style="color:#f92672">.</span><span style="color:#a6e22e">substring</span><span style="color:#f92672">(</span>3<span style="color:#f92672">),</span> 0<span style="color:#f92672">)).</span><span style="color:#a6e22e">split</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;;&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> intValue <span style="color:#f92672">=</span> Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>split<span style="color:#f92672">[</span>1<span style="color:#f92672">]).</span><span style="color:#a6e22e">intValue</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> intValue2 <span style="color:#f92672">=</span> Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>split<span style="color:#f92672">[</span>2<span style="color:#f92672">]).</span><span style="color:#a6e22e">intValue</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> sharedPreferences<span style="color:#f92672">.</span><span style="color:#a6e22e">getInt</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;k&#34;</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i2 <span style="color:#f92672">=</span> sharedPreferences<span style="color:#f92672">.</span><span style="color:#a6e22e">getInt</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;g&#34;</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//if i &lt; 8, increment the k value by ine
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>i <span style="color:#f92672">&lt;</span> intValue<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        edit<span style="color:#f92672">.</span><span style="color:#a6e22e">putInt</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;k&#34;</span><span style="color:#f92672">,</span> i <span style="color:#f92672">+</span> 1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        edit<span style="color:#f92672">.</span><span style="color:#a6e22e">apply</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//if i2 &gt;= intValue2, do not increment the g value
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>sharedPreferences<span style="color:#f92672">.</span><span style="color:#a6e22e">getInt</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;k&#34;</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> intValue <span style="color:#f92672">||</span> i2 <span style="color:#f92672">&gt;=</span> intValue2<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//increment g by one
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//as the cap is 2 (from the previous if, it will get here at most two times)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    edit<span style="color:#f92672">.</span><span style="color:#a6e22e">putInt</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;g&#34;</span><span style="color:#f92672">,</span> i2 <span style="color:#f92672">+</span> 1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    edit<span style="color:#f92672">.</span><span style="color:#a6e22e">apply</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//show the message &#39;ANDROID-1.COM&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Toast<span style="color:#f92672">.</span><span style="color:#a6e22e">makeText</span><span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> split<span style="color:#f92672">[</span>3<span style="color:#f92672">],</span> 1<span style="color:#f92672">).</span><span style="color:#a6e22e">show</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>By the static analysis I could not find what <em>isAdsReadyForReward</em> specifically used for, and what the <em>k</em> and <em>g</em> values works in here. I followed the analysis dynamically in order to understand if the file exists and how it is used (or if it has something to do with the hack itself).</p>
<p><strong>4. Reading the content of the data.save zip file</strong></p>
<p>At this point I understood how the mod was executed, but I wanted to know what was specifically changed in the game files, so I did an extra effort. I unzipped the files stored in the &ldquo;data.save&rdquo; folder, and got the following folders:</p>
<ul>
<li>shared_prefs: which is used to store xml files with key/value pairs.</li>
<li>files: which is used to store random files.</li>
</ul>
<p>Reading the content I had an hypothesis on how the cheat worked. It seemed to be kind of a save state of a game. Maybe the person that executed the hack changed a file with the amount of coins as we stated above, so I needed to know which files seemed to be the candidates. In order to do so I run the original game in an emulator. Even when the game didn&rsquo;t run completely due to problems I assumed were related to the download of assets from a non-existent folder, it could install the application and the common files.</p>
<p>The comparison of the files in the <em>shared_folder</em> folder showed two differences:</p>
<ul>
<li>FBAdPrefs.xml: Which is related to Fb ads and it does not seem to be related to the coin mod.</li>
<li>com.rovio.angrybirds_preferences: This file has some configurations related to the configuration of the <em>Facebook Events library</em>, which is used to track the usage of the application. I highly doubt it would have anything to do with the mod.</li>
</ul>
<p>The comparison of the files in the <em>files</em> folder showed several differences in files and many new files as shown in the image:</p>
<p><img src="/images/blog/behind-the-cheat-1/image3.png" alt="Mobile Game Hacking: Angry Birds 3"></p>
<ul>
<li>
<p>The folder <em>adc3</em> has information about requests and cache of a lib related to ads. Checking the content I found that it used the following URL: <a href="https://adc-ad-assets.adtilt.com">https://adc-ad-assets.adtilt.com</a> in order to download the Javascript files to control the ads. As I didn&rsquo;t know that library I searched a bit and I got to the following URL (<a href="https://clients.adcolony.com/login">https://clients.adcolony.com/login</a>) which is the owner of the <em>adtilt.com</em> domain. As it seems to be a genuine Ad library and there is no apparent change (luckily all the files were <em>Json</em> ones) I discarded those ones as being the ones with the hack.</p>
</li>
<li>
<p>ugc.zip and net.hockeyapp.android are in the original version but not in the modded one, so they weren&rsquo;t of interest for me.</p>
</li>
<li>
<p>A032DB9BCE0E6D15383C512251BA805133D6F4A7DGC1 vs AD6C37A2B7F3FA97CBE5CF87F987E7F5F8EE9693BGC1. The file names seem to be generated randomly. I run the original application several times and I got new files each time but with the same content. The file content only changed between the modded version vs the non modded one. As I did not have any clue on what the file was I followed up with the other leads.</p>
</li>
<li>
<p>bi_data.lua, highscore.lua and settings.lua: These files are binary ones. They seemed to be binary Lua scripts, but when I opened them I couldn&rsquo;t find the initial header for the Lua files: (1b 4c 75 61). So they probably are encrypted somehow. From these three the most interesting one was <em>settings.lua</em>, that might get something that could change the behavior of the game.</p>
</li>
<li>
<p>daily_changes.json: Json file which configures what can be retrieved from each day of activity. Even when this could have been a possible target by changing the prizes in coins from 20 or 50 to a high number, it was not the case.</p>
</li>
<li>
<p>cacert.pem: some certificates changed between the modded version and the last one (I suspect in fact that the original version for the mod was a previous one).</p>
</li>
<li>
<p>fusion.registry: I have no clue on what this file is. I searched for the file and what could it be and I couldn&rsquo;t find any reference. The game downloads or generates it when it is installed. As the Java packages for the game starts with &ldquo;com.rovio.fusion&rdquo; I suspect it is related to the engine used for the game but I&rsquo;m not sure.</p>
</li>
</ul>
<p><strong>5. Trying to decompile lua files</strong></p>
<p>As my principal lead to the game mod was related to the encrypted lua files, I tried to search how the encryption happened. I installed the Angry Birds 8.0.3 more times in order to understand if the files changed each time the application was installed or it was something that was stable, and I compared the encrypted files in order to see If I could understand if they were all different. The first thing I found was that the file was different each time the application is installed, and that all the files started in the same way:</p>
<p><img src="/images/blog/behind-the-cheat-1/image4.png" alt="Mobile Game Hacking: Angry Birds 4"></p>
<p>I searched for known file signature but I couldn&rsquo;t find any. Another suspicious thing was that each time the application was installed a new file in the folders was generated. It had common header (which I do not know what it was) and different content each time it was installed. My hypothesis here is that this random file might be the key to encrypt the other files. But as I did not have any clue on what they were I had two alternatives:</p>
<p>a- Find in internet someone who had already done this.  <br>
b- Reverse the game to find how this files are generated.</p>
<p>The option &ldquo;a&rdquo; is not hard and does not require a lot of time, so I tried to find that information, which led me to many different interesting discoveries. The first one was to a forum where people did mods for Angry Birds. There I found that there are multiple other *Lua files that are the core of the game which are also encrypted in the following way:
1- they are zipped with <em>7z</em>. 
2- they are encrypted with a key that is hardcoded somewhere in the application.</p>
<p>I also found several open source applications in Github that could be used to decrypt those files (like <a href="https://github.com/AB360-org/LUAManager">https://github.com/AB360-org/LUAManager</a> or <a href="https://github.com/jooapa/Angry_Birds_Decompilation/tree/master)">https://github.com/jooapa/Angry_Birds_Decompilation/tree/master)</a>. I tried the applications on the scripts in <em>assets/data</em> folder and I could decrypt and decompile them (as they were in binary <em>Lua</em>). This could help in case I had to understand how those files are generated. Another interesting thing about this is that the best way to mod or create cheats would probably be this one instead of the one used for the analyzed hack, as anyone could directly work with the Lua scripts instead of with binaries and the hacks created could be much more complex.</p>
<p>Another interesting blogpost I found was related to the encyption of the <em>highscore.lua and settings.lua</em> file (for another version of Angry Birds) or directly for <em>cocos2d</em> (showing the methodology with some Angry Birds game). Apparently the encryption is AES with CBC and PKCS#7 padding. I needed to confirm this and also finding the key to decrypt the files (which got me to the option b). So I followed these steps:</p>
<p>The key used did not seem to be static as each time the application is installed it will encrypt te same file differently, so at least there is something that changes between installation and installation. I will assume the methods for encrypting the files are the same ones</p>
<p>As I followed the examples in the blogposts I tried to find methods related to decryption in the <em>libAngryBirdsClassic.so</em> but I couldn&rsquo;t find any similar. So this path was closed.</p>
<p>I found a method that used the &ldquo;highscore.lua&rdquo; and &ldquo;settings.lua&rdquo; scripts but they were pretty complex and I did not want to follow the reversing of all the methods related to this files, given that there was no debugging information in the methods, so it would take a lot of time.</p>
<p>I followed the <em>b</em> path. In this case I decoded all the <em>Lua</em> files that are in the <em>assets/data/scripts</em> files with the <em>Lua</em> Manager in order to understand what was being stored in the files and maybe to know how they were loaded.</p>
<p>By analyzing the code I found two functions that were wrappers and did not have an implementation (at least in the <em>data/scripts</em> folder) were:</p>
<ul>
<li>saveLuaFileWrapper: used to store any file in the files folder. I found references to method invoked with <em>settings.lua and highscores.lua</em>. Sadly the true method that would save a file was called &ldquo;saveLuaFile&rdquo; which is not in the files defined here but in the <em>libAngryBirdsClassic.so</em> as shown in the following image.</li>
</ul>
<p><img src="/images/blog/behind-the-cheat-1/image5.png" alt="Mobile Game Hacking: Angry Birds 5"></p>
<ul>
<li>loadTableFromFile: which loads some values stored in a file to a structure. It is used in the save method in order to load the stored files and then merged with the structures that are in memory as shown in the <em>saveLuaWrapper</em> snippet and also used in the logout functionality to load the content of the settings and highscore values.</li>
</ul>
<p>The <em>saveLuaWrapper</em> function is the following one:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">saveLuaFileWrapper</span>(_ARG_0_, _ARG_1_, _ARG_2_)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> _G.native.Account <span style="color:#f92672">and</span> _G.native.Account.isLoggedIn() <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> _ARG_1_ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;settings&#34;</span> <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>      loadTableFromFile(<span style="color:#e6db74">&#34;settings.lua&#34;</span>, <span style="color:#e6db74">&#34;tempLocalSettings&#34;</span>)
</span></span><span style="display:flex;"><span>      tempLocalSettings <span style="color:#f92672">=</span> RovioAccountSettingsManager:combineSettings(tempLocalSettings, RovioAccountSettingsManager:cleanSyncableSettings(settings), <span style="color:#66d9ef">true</span>)
</span></span><span style="display:flex;"><span>      saveLuaFile(<span style="color:#e6db74">&#34;settings.lua&#34;</span>, <span style="color:#e6db74">&#34;tempLocalSettings&#34;</span>, _ARG_2_)
</span></span><span style="display:flex;"><span>      tempAccountSettings <span style="color:#f92672">=</span> RovioAccountSettingsManager:cleanLocalSettings(settings)
</span></span><span style="display:flex;"><span>      _ARG_0_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;settings_&#34;</span> <span style="color:#f92672">..</span> _G.native.Account.getAccountId() <span style="color:#f92672">..</span> <span style="color:#e6db74">&#34;.lua&#34;</span>
</span></span><span style="display:flex;"><span>      saveLuaFile(_ARG_0_, <span style="color:#e6db74">&#34;tempAccountSettings&#34;</span>, _ARG_2_)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elseif</span> _ARG_1_ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;highscores&#34;</span> <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>      _ARG_0_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;highscores_&#34;</span> <span style="color:#f92672">..</span> _G.native.Account.getAccountId() <span style="color:#f92672">..</span> <span style="color:#e6db74">&#34;.lua&#34;</span>
</span></span><span style="display:flex;"><span>      saveLuaFile(_ARG_0_, _ARG_1_, _ARG_2_)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  saveLuaFile(_ARG_0_, _ARG_1_, _ARG_2_)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>Another interesting detail related to stored files is that whenever the user logs in, the file used to track the highscores and state of the account are other ones, <em>highscore_&lt;account_id_hash&gt;.lua and settings_&lt;account_id_hash&gt;.lua</em>. I did not find this files because the game crashed at the beginning. From this detail I infered that the hack was made using a guest account, and modifying the original values.</p>
<p>In the <em>saveLuaFileWrapper</em> I could also see that whenever the account was being saved, the application cleaned from the <em>tempLocalSettings</em> the values that should come from the remote configuration. I assume this is because in the settings structure there were currency values, like gems. So cleaning it is a way to &ldquo;synchronize&rdquo; values with the server. In the case of the guest account this is not done, so the hacker would be able to modify and persist any value there. This could be a problem in the case of the guest accounts if there were no validation server-side of the bought items.</p>
<p>After reading some code I understood the following:</p>
<ul>
<li>
<p><em>bi_data</em> collects events related to the use of the game. It must not have anything to do with the unlimited currency.</p>
</li>
<li>
<p><em>highscores</em> As the name states, it tracks the performance of the person in each level. It is somehow related to currency as when you have certain score, it will give you more coins or stars, but this event is only triggered when the level is completed.</p>
</li>
<li>
<p><em>settings</em> has the state of the user and the game. Even when it was not possible to find statically a method that received settings as a paramenter and added coins (because of the way the applicatios is coded and how LUA uses global scopes and parameters), I found that it hold parameters related to the account such as if it was premium or not, if videos of Ads should be seen and many more.</p>
</li>
</ul>
<p>Because of that information I got pretty sure that the ingame currency should be stored in that file.</p>
<p><strong>Bonus track: What does the unZipIt do?</strong></p>
<p>Basically the method reads a zip file and create the subfolders in the destination folder and unzips the files there.</p>
<p>The method is implemented in the following way. I&rsquo;ll add comments in some lines and remove the ones that are not important:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">unZipIt</span><span style="color:#f92672">(</span>InputStream inputStream<span style="color:#f92672">,</span> String str<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    ZipInputStream zipInputStream <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ZipInputStream<span style="color:#f92672">(</span>inputStream<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* this is done in the method more than once. I think it is done to obfuscate the method somehow or to let the modder check some conditions and if the conditions  weren&#39;t met, abort the execution. I think this because daDakdsIID is 0 and PdsjdolaSd is 0 as well, and they are never changed in this game. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>daDakdsIID <span style="color:#f92672">!=</span> PdsjdolaSd<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Exception<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;System error...&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> bArr <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[</span>1024<span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*create the destination folder. In our case as the destination is the root application folder in the internal storage, the folder is already created when the app is installed.*/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> File<span style="color:#f92672">(</span>str<span style="color:#f92672">).</span><span style="color:#a6e22e">mkdirs</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    ZipEntry nextEntry <span style="color:#f92672">=</span> zipInputStream<span style="color:#f92672">.</span><span style="color:#a6e22e">getNextEntry</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>nextEntry <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//discard folder list in the zip file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>nextEntry<span style="color:#f92672">.</span><span style="color:#a6e22e">isDirectory</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            nextEntry <span style="color:#f92672">=</span> zipInputStream<span style="color:#f92672">.</span><span style="color:#a6e22e">getNextEntry</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/* on each file listed in the zip take the folder path and create it recursively. e.g.:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                - files/ (discarded in the previous if)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                - files/folder/ (discarded in the previous if)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                - files/folder/file.xml
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> lastIndexOf <span style="color:#f92672">=</span> nextEntry<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">().</span><span style="color:#a6e22e">lastIndexOf</span><span style="color:#f92672">(</span>47<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>lastIndexOf <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                lastIndexOf <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                following the example take files/folder/ and create it recursevely in the /data/data/package_id/ folder.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> File<span style="color:#f92672">(</span>str <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">+</span> nextEntry<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">().</span><span style="color:#a6e22e">substring</span><span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> lastIndexOf<span style="color:#f92672">)).</span><span style="color:#a6e22e">mkdirs</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            FileOutputStream fileOutputStream <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileOutputStream<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> File<span style="color:#f92672">(</span>str <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">+</span> nextEntry<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()),</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//copy file to the destination.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">int</span> read <span style="color:#f92672">=</span> zipInputStream<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>bArr<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>read <span style="color:#f92672">&lt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                fileOutputStream<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>bArr<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> read<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            fileOutputStream<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            nextEntry <span style="color:#f92672">=</span> zipInputStream<span style="color:#f92672">.</span><span style="color:#a6e22e">getNextEntry</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>This method does not have anything fancy. Note that it is prone to <em>ZipSlip</em>, so do not copy and paste it to use it in your application :)</p>
<p><strong>Conclusion</strong></p>
<p>Even when I couldn&rsquo;t confirm the hypothesis of the way the hack was done, the hacker should have followed the next steps:</p>
<ol>
<li>Modify the ingame currency in a guest account using some memory editor, like GameGuardian (<a href="https://gameguardian.net/forum/topic/23118-angry-birds-classic/)">https://gameguardian.net/forum/topic/23118-angry-birds-classic/)</a>.</li>
<li>Closing the game should have stored the files with the changes in currency.</li>
<li>Dump the game files with adb.</li>
<li>Modify the game to add the scripts that will override the files in the private folder (Note that the hacker just dumped all the files and stored them as they were in the datasave file).</li>
<li>Pack the game.</li>
</ol>
<p>Note that it is not that hard to achieve this technique, as there is no much need of knowledge of reversing or coding, as the methods are generic and well documented. There are plenty of ways to detect this type of attacks and to prevent them, as <em>RASP techniques</em> or authoritative servers that validates each transaction.</p>
<p><strong>If you are a game developer and you want to prevent this type of attacks or understand how resilient is your application to hacks, you can reach us and we will happily help you on the security review of your games.</strong></p>

        </div>
        </div>
      </div>
<!-- sidebar -->
<aside class="col-lg-3 order-2 order-lg-2">
  <!-- categories -->
  <div class="bg-white mb-5">
    <h4 class="mb-4 h4-bold">Categories</h4>
    <ul class="list-unstyled" style='line-height: 1.2; font-family: "Poppins", sans-serif; -webkit-font-smoothing: antialiased; color: #5c5c77;'>
      <li class="border-bottom"><a href="/categories/gamehacking/" class="d-block pb-3 mt-3">Gamehacking</a></li>
      <li class="border-bottom"><a href="/categories/methodologies/" class="d-block pb-3 mt-3">Methodologies</a></li>
    </ul>
  </div>
  <!-- tags -->
  <div class="bg-white mb-5">
    <h4 class="mb-4 h4-bold">Tags</h4>
    <ul class="list-inline tag-list" style='line-height: 1.2; font-family: "Poppins", sans-serif; -webkit-font-smoothing: antialiased; color: #5c5c77;'>
      <li class="list-inline-item mb-2"><a href="/tags/assessment/">Assessment</a></li>
      <li class="list-inline-item mb-2"><a href="/tags/cloud/">Cloud</a></li>
      <li class="list-inline-item mb-2"><a href="/tags/game/">Game</a></li>
      <li class="list-inline-item mb-2"><a href="/tags/generative/">Generative</a></li>
      <li class="list-inline-item mb-2"><a href="/tags/hacking/">Hacking</a></li>
      <li class="list-inline-item mb-2"><a href="/tags/java/">Java</a></li>
      <li class="list-inline-item mb-2"><a href="/tags/llm/">Llm</a></li>
      <li class="list-inline-item mb-2"><a href="/tags/methodology/">Methodology</a></li>
      <li class="list-inline-item mb-2"><a href="/tags/mobile/">Mobile</a></li>
      <li class="list-inline-item mb-2"><a href="/tags/red-team/">Red team</a></li>
      <li class="list-inline-item mb-2"><a href="/tags/reversing/">Reversing</a></li>
      <li class="list-inline-item mb-2"><a href="/tags/sdlc/">SDLC</a></li>
      <li class="list-inline-item mb-2"><a href="/tags/web/">Web</a></li>
    </ul>
  </div>
  <!-- latest post -->
  <div class="bg-white">
    <h4 class="mb-4 h4-bold">Latest Article</h4>
    <!-- post-item -->
    
    <div class="media border-bottom border-color pb-3 mb-3" style='display: flex;'>
      <a href="https://vultursec.com/blog/behind-the-cheat-1/"><img class="mr-3 post-thumb-sm" style="margin-right: 1rem!important;" src="https://vultursec.com/images/blog/behind-the-cheat-1/angry-birds-image.jpeg"></a>
      <div class="media-body" style='line-height: 1.2; font-family: "Poppins", sans-serif; -webkit-font-smoothing: antialiased; font-size: 15px; color: #5c5c77;'>
        <a href="https://vultursec.com/blog/behind-the-cheat-1/">
          <h5 class="mt-0" style='font-size: 18px; color: #1e1e4b; font-family: "futura-bold"; font-weight: 700; line-height: 1.2;'>Behind the Cheat - Angry Birds Classics</h5>
        </a>
        14 Feb 2024
      </div>
    </div>
    
    <div class="media border-bottom border-color pb-3 mb-3" style='display: flex;'>
      <a href="https://vultursec.com/blog/gen-ai-for-gaming/"><img class="mr-3 post-thumb-sm" style="margin-right: 1rem!important;" src="https://vultursec.com/images/blog/genai-security/banner1.jpeg"></a>
      <div class="media-body" style='line-height: 1.2; font-family: "Poppins", sans-serif; -webkit-font-smoothing: antialiased; font-size: 15px; color: #5c5c77;'>
        <a href="https://vultursec.com/blog/gen-ai-for-gaming/">
          <h5 class="mt-0" style='font-size: 18px; color: #1e1e4b; font-family: "futura-bold"; font-weight: 700; line-height: 1.2;'>Risks of using Generative AI technologies in Video Game development</h5>
        </a>
        17 Jan 2024
      </div>
    </div>
    
    <div class="media border-bottom border-color pb-3 mb-3" style='display: flex;'>
      <a href="https://vultursec.com/blog/game-hacking-2023/"><img class="mr-3 post-thumb-sm" style="margin-right: 1rem!important;" src="https://vultursec.com/images/blog/farewell-2023/farewell-2023.jpeg"></a>
      <div class="media-body" style='line-height: 1.2; font-family: "Poppins", sans-serif; -webkit-font-smoothing: antialiased; font-size: 15px; color: #5c5c77;'>
        <a href="https://vultursec.com/blog/game-hacking-2023/">
          <h5 class="mt-0" style='font-size: 18px; color: #1e1e4b; font-family: "futura-bold"; font-weight: 700; line-height: 1.2;'>Game Hacking Summary 2023</h5>
        </a>
        30 Dec 2023
      </div>
    </div>
    
  </div>
</aside>
<!-- /sidebar -->
    </div>
  </div>
</section>




<footer>
     <script type="text/javascript">
      let searchField = document.getElementById("searchField");
      let queryText = window.location.search.split("=")[1];
      if (queryText) {
        searchField.value = queryText.includes("-")
          ? queryText.replaceAll("-", " ")
          : queryText;
      }
      let searchValue = "";
      function handleChange(e) {
        searchValue = e.value;
      }
      document
        .getElementById("searchForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          window.location.href = `/search.html?val=${searchValue.replaceAll(
            " ",
            "-"
          )}`;
        });
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.9.2/umd/popper.min.js" defer=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.0/js/bootstrap.min.js" defer=""></script>
    <script src="https://vultursec.com/js/aos.js" defer=""></script>
    <script src="https://vultursec.com/js/custom.js" defer=""></script>
 </footer>

<grammarly-desktop-integration data-grammarly-shadow-root="true"></grammarly-desktop-integration></body>

</html>